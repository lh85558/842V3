# TP842N v3 OpenWrt 21.02 打印服务器编译指南

## ✅ 配置完成清单

### 核心更改

- ✅ **OpenWrt版本**: 从LEDE → OpenWrt 21.02 LTS官方版
- ✅ **架构迁移**: ar71xx → ath79 (新架构，长期维护)
- ✅ **设备标识**: `tplink_tl-wr842n-v3` (ath79标准命名)
- ✅ **CUPS版本**: 2.4.2 完整中文支持
- ✅ **Actions版本**: 全部更新到最新版本（v4/v2）

### 依赖包检查

#### 已安装的核心包
```
✅ cups 2.4.2                    - 打印服务核心
✅ cups-client                   - 客户端工具
✅ cups-filters                  - 打印过滤器
✅ ghostscript 9.53.x            - PDF/PS渲染
✅ hplip-common                  - HP驱动核心
✅ hplip-sane                    - HP扫描支持
✅ foomatic-db                   - 打印机数据库
✅ foomatic-filters              - Foomatic过滤器
✅ p910nd                        - 网络打印
✅ luci-app-p910nd               - Web界面
✅ luci-app-autoreboot           - 定时重启
✅ luci-app-samba4               - 文件共享
✅ luci-i18n-*-zh-cn             - 中文语言包
✅ fonts-chinese                 - 中文字体
```

#### USB支持
```
✅ kmod-usb-core                 - USB核心
✅ kmod-usb2                     - USB2.0支持
✅ kmod-usb-printer              - USB打印机
✅ kmod-usb-storage              - USB存储
```

#### 无线驱动 (ath79专用)
```
✅ kmod-ath9k                    - Atheros 802.11n
✅ kmod-ath9k-common             - 公共库
✅ wpad-basic-wolfssl            - WPA认证
```

### 不需要的包（已移除）
```
❌ luci-app-ddns                 - 动态DNS（不需要）
❌ luci-app-upnp                 - UPnP（不需要）
❌ luci-app-adbyby-plus          - 广告过滤（节省空间）
❌ luci-app-ssr-plus             - 代理工具（节省空间）
❌ ppp/pppoe                     - 拨号功能（不需要）
```

## 🚀 推送代码到GitHub

### 方法一：使用Git命令行（需要认证）

```bash
cd c:/Users/Administrator/CodeBuddy/20251228022507
git push origin main
```

如果提示需要认证：
1. 输入GitHub用户名：`lh85558`
2. 输入Personal Access Token（不是密码）

### 方法二：使用GitHub Desktop

1. 打开GitHub Desktop
2. 添加本地仓库：`c:/Users/Administrator/CodeBuddy/20251228022507`
3. 点击 "Push origin"
4. 登录GitHub账号

### 方法三：创建Personal Access Token

1. 访问：https://github.com/settings/tokens
2. 点击 "Generate new token (classic)"
3. 勾选权限：`repo` (完整仓库访问)
4. 生成并复制token
5. 使用token作为密码推送

```bash
git push https://lh85558:你的TOKEN@github.com/lh85558/842nv3.git main
```

## 📦 启动编译

推送成功后，有两种方式启动编译：

### 自动触发
推送代码会自动触发GitHub Actions编译

### 手动触发
1. 访问：https://github.com/lh85558/842nv3/actions
2. 选择 "编译TP842N-v3打印服务器固件"
3. 点击 "Run workflow"
4. 选择 `main` 分支
5. 点击绿色按钮启动

## ⏱️ 编译时间

| 阶段 | 预计时间 |
|------|---------|
| 环境初始化 | 5分钟 |
| 克隆源码 (OpenWrt 21.02) | 5分钟 |
| 更新feeds | 8-12分钟 |
| 下载依赖包 | 15-20分钟 |
| 编译固件 | 50-70分钟 |
| **总计** | **80-110分钟** |

## 📥 下载固件

编译完成后：

1. 访问：https://github.com/lh85558/842nv3/releases
2. 找到最新的Release（按日期命名）
3. 下载固件文件：

### 固件文件说明

```
📦 openwrt-21.02.x-ath79-generic-tplink_tl-wr842n-v3-squashfs-factory.bin
   ↳ 用于首次刷机（从原厂固件）
   ↳ 大小：约 7-8 MB

📦 openwrt-21.02.x-ath79-generic-tplink_tl-wr842n-v3-squashfs-sysupgrade.bin
   ↳ 用于升级固件（从OpenWrt升级）
   ↳ 大小：约 7-8 MB
   ↳ 可保留配置
```

## 🔧 固件信息

### 默认配置
```
LAN IP:    192.168.10.1
用户名:     admin
密码:       thdn12345678
WiFi SSID:  THDN-dayin
WiFi密码:   thdn12345678
主机名:     THDN-PrintServer
```

### 服务访问
```
Web管理:    http://192.168.10.1
CUPS管理:   http://192.168.10.1:631
SSH:        ssh root@192.168.10.1
```

### 功能特性
- ✅ CUPS 2.4.2 中文打印服务
- ✅ HP LaserJet 1020/1020plus/1007/1008/1108 驱动
- ✅ USB打印机热插拔自动配置
- ✅ 网络打印 (IPP + P910nd)
- ✅ 远程打印支持
- ✅ 定时重启功能
- ✅ AP模式WiFi
- ✅ 中文管理界面
- ✅ Samba文件共享

## 🖨️ 支持的打印机

| 型号 | USB ID | 状态 |
|------|--------|------|
| HP LaserJet 1020 | 03f0:2b17 | ✅ 完全支持 |
| HP LaserJet 1020plus | 03f0:3d17 | ✅ 完全支持 |
| HP LaserJet 1018 | 03f0:1017 | ✅ 完全支持 |
| HP LaserJet 1007 | 03f0:5811 | ✅ 完全支持 |
| HP LaserJet 1008 | 03f0:5c11 | ✅ 完全支持 |
| HP LaserJet 1108 | 03f0:4817 | ✅ 完全支持 |

## 📊 固件大小估算

```
┌─────────────────────────────────────┐
│ 组件           大小       占比       │
├─────────────────────────────────────┤
│ 内核           2.5 MB    18%        │
│ 基础系统       4.0 MB    29%        │
│ LuCI界面       1.5 MB    11%        │
│ CUPS服务       2.5 MB    18%        │
│ 打印驱动       1.5 MB    11%        │
│ 其他工具       1.5 MB    11%        │
│ 压缩后         0.5 MB    3%         │
├─────────────────────────────────────┤
│ 总计           ~13-14MB  100%       │
│ Flash容量      16 MB                │
│ 剩余空间       2-3 MB    (15-20%)   │
└─────────────────────────────────────┘
```

## 🔍 验证配置

### 检查目标平台
```bash
# 应该显示 ath79
grep "CONFIG_TARGET_ath79=y" .config

# 应该显示 tplink_tl-wr842n-v3
grep "CONFIG_TARGET.*tplink_tl-wr842n-v3" .config
```

### 检查CUPS包
```bash
# 应该显示多个CUPS相关包
grep "CONFIG_PACKAGE_cups" .config
```

### 检查中文支持
```bash
# 应该显示中文语言包
grep "CONFIG_LUCI_LANG_zh_Hans=y" .config
```

## 🛠️ 故障排除

### 编译失败

**问题**: feeds更新失败
```bash
解决方案：
1. 检查网络连接
2. 使用GitHub代理（已配置ghproxy.com）
3. 手动重试编译
```

**问题**: 依赖包下载失败
```bash
解决方案：
1. GitHub Actions会自动重试
2. 查看编译日志确定具体包
3. 可能需要调整.config移除某些包
```

### 固件太大

如果编译后固件超过16MB：

```bash
# 在.config中移除以下包（可选）：
# CONFIG_PACKAGE_luci-app-samba4 is not set
# CONFIG_PACKAGE_ghostscript-fonts-std is not set
# CONFIG_PACKAGE_python3-light is not set
```

### 刷机失败

**问题**: 原厂固件不认OpenWrt固件
```bash
解决方案：
1. 确保使用 factory.bin 文件
2. 尝试使用TFTP恢复模式
3. 检查设备型号是否正确（必须是v3）
```

## 📚 相关文档

- [OpenWrt 21.02 说明](./OpenWrt-21.02-说明.md) - 详细技术文档
- [国内镜像说明](./国内镜像说明.md) - 加速配置
- [README.md](./README.md) - 项目主页

## 🔗 有用链接

- **GitHub仓库**: https://github.com/lh85558/842nv3
- **Actions编译**: https://github.com/lh85558/842nv3/actions
- **Releases下载**: https://github.com/lh85558/842nv3/releases
- **OpenWrt官方**: https://openwrt.org/
- **CUPS文档**: https://www.cups.org/documentation.html

## 📞 支持

如遇问题：

1. 查看 [OpenWrt-21.02-说明.md](./OpenWrt-21.02-说明.md) 中的故障排除章节
2. 检查GitHub Actions编译日志
3. 访问OpenWrt论坛：https://forum.openwrt.org/

---

**更新时间**: 2025-12-28  
**OpenWrt版本**: 21.02 LTS  
**维护者**: lh85558
